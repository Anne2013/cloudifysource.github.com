---
layout: default
title: Developing a custom cloud driver
category: Developer Guide
---

p. How to develop your custom Cloud Driver.

h1. How does the Cloud Driver Works – Technical introduction

Cloudify Cloud Driver (ProvisioningDriver is the Interface Name), has 4 main scenarios
# Bootstrap Cloud – which is the installation of Cloudify Management VM and Controller on a Cloud from your laptop
# Install Application – which is the creation of Application VMs with Cloudify Agent on them as part of an application deployment. In this case, the Cloud Driver resides on the management VM as part of Cloudify Controller
# Uninstall Application – termination of Application VMs.
# Teardown Cloud – Termination of all Cloudify VMs and components on the Cloud.

Another scenario: Cluster Healing is the same as Install Application from Cloud Driver perspective

The below sequence diagrams explains it in a more technical fashion.

<img src="/guide/images/clouddrivers/bootstrapping.png"/>

<img src="/guide/images/clouddrivers/installApplication.png"/>

<img src="/guide/images/clouddrivers/uninstallApplication.png"/>

<img src="/guide/images/clouddrivers/tearDown.png"/>

<img src="/guide/images/clouddrivers/cluster-healing.png"/>


h3. Flows explained

h4. Bootstrapping Cloud

In this scenario the Cloud Driver resides on the client side as no VM with Cloudify Server (Controller) exist.
The user instructs the Cloudify Interactive Shell to bootstrap Cloudify, providing a specific Cloud Driver implementation and configuration.
The Cloud Driver is instantiated by the shell and now the shell will need to give the Driver Reference to its configuration object
(org.cloudifysource.dsl.cloud.Cloud).  This is done by calling the setConfig method.

Next the Cloud Driver will be invoked by the shell using the startManagementMachines method.
This in turn will call the Cloud API using the API security settings in order to get the management VMs.

<script src="https://gist.github.com/2036493.js?file=createServer.java"></script>

This will return an array of MachineDetails (org.cloudifysource.esc.driver.provisioning.MachineDetails) for each of the management Machines.
These details will be used by Cloudify CLI to connect to the Hosts and install the management components on them. Finally Cloudify will start the Cloudify Controller components: the ESM, the GSM, the LUS and the Management Space. It will also start the Web Container for the Management application and the REST API container.

h4. Installing an Application

This is a server side scenario from Cloud Driver perspective. Once the Controller had been instructed to install an application, it will command the Driver to start X virtual machines according to the recipe instructions.
The Cloud Driver needs first to get the Admin Object so it can report to the Admin about the VMs public IPs and other details. This is done using the setAdmin method by the Controller
Next the Controller will ask the Driver to repeat the startMachine method until all machines are up and running with Cloudify Agent registered in the LUS or until timeout occurs.
The startMachine flow is simple: The driver calls the IaaS API. Polls the API for the VM details. Ping the VM to makes sure its accessible and then access it with SSH, this time installing the Cloudify Agent components: GSA and GSC and starting them.
The Driver will get the machine information from the template properties corresponding to the requested template name. The template information is within the config object
The same flow will happen if the Controller needs to compensate for a crushed VM or to rebalance one of the services.

h4. Uninstalling an Application

h4. Tearing Down the Cloud


h1. Setting Up Your Project

p. This section will teach you what you need in your eclipse project

h1. Before You Code

p. This section explains how to get what you need from your cloud account – credentials, SSH access etc.

h3. Getting the Security Credentials for API Access

The security credentials you will need to have for the cloud driver are of two kinds:
* The credentials for the Cloud IaaS API calls
* The credentials for accessing a VM with SSH
In some cases you will need the storage credentials as well

h3. Getting the right Image and HW for Management
You will need to define HW / SW templates in the Cloud Driver configuration file. One of them will define the management VM. 
Keep In mind the following:
* The management VM must have public IP to be accessed from the internet or other subnets within the organization using HTTP
* The management VM must have SSH access to be installed
* It will require X of disk space and Y GB of RAM memory
* Currently it must be a Linux Image 




h1. The Cloud Driver Interface

The Cloud Driver Interface defines the methods for provisioning and installing the management virtual machines, the application virtual machines and getting Cloud information back.

* The {{setConfig}} method is called after the user invoked the {{bootstrap-cloud}} command from the Cloudify shell, loading the configuration file and preparing the Cloud Driver configuration {{Map}}
* The {{bootstrapCloud}} method succeeds the {{setConfig}} method; provisions the Cloudify management VM and installs the different Cloudify management services on that VM(s)
* The {{startMachine}} method called by the ESM when a new service needs to be installed, will provision a new VM and install the Clodify agent on this VM, returning the VM details
* The {{stopMachine}} method called by the ESM when a service needs to be shutdown or when a node needs to be moved to a larger machine etc, will shutdown and terminate the VM specified.
* The {{teardownCloud}} method will be shutting down and terminating any VM associated with the current Cloudify installation, once the user invoked the {{teardown-cloud}} from the Shell. 


p. <script src="https://gist.github.com/1744993.js?file=CloudifyProvisioning.java"></script>

h1. The Cloud Driver Configuration DSL File

The Cloud Driver configuration file describes a particular configuration for the specific cloud vendor with several sub-sections:
* Configuration section that holds the management machine template name ans some other general configuration attributes
* Provider section describes the different attributes needed for the cloud driver to upload files from the shell to the cloud, accessing the management VMs etc.
* User section that describes the security credentials required for Cloudify to access the cloud API
* Templates section which is a map of VM template aliases mapped to their configurations. A template is a set of attributes the cloud driver needs to locate the suitable image to use and the machine HW to provision. Users reference the template aliases in the service recipe in order to get the required SW and HW from the cloud without addressing a specific Cloud API or terminology.
* Custom section is used by the developer of the cloud driver to add any set of custom attributes


<br/>Here is an example of ec2-cloud.groovy (For Amazon EC2 cloud with placeholders): 
<script src="https://gist.github.com/1722422.js?file=ec2-cloud.groovy"></script>


h2. Packaging it all into a Cloud Plugin

     TBD

h2. Adding a Plugin Folder

     TBD

h2. Packing the Cloud Driver to a jar

     TBD

h2. Placing the Cloud Driver Config File

     TBD

